<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ki·ªÉm tra ƒë∆°n h√†ng (don_hang)</title>

<!-- Ki·ªÉm tra quy·ªÅn truy c·∫≠p b·∫±ng token -->
<script src="./js/auth_token.js"></script>
<script>checkAccess();</script>

<!-- L·∫§Y key n·ªôi b·ªô ƒë·ªÉ g·ªçi /api/getConfig (ƒë·ªãnh nghƒ©a window.getInternalKey) -->
<script src="./js/internal_key.js"></script>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous"></script>

<link rel="stylesheet" href="./css/check_don.css" />

<style>
  /* User bar */
  #userBar{
    position:fixed; top:8px; right:16px;
    display:flex; align-items:center; gap:10px; z-index:2000;
    background:transparent;
  }
  #userBar .name{ max-width:220px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  #notifyBell{ background:none; border:0; cursor:pointer; font-size:18px; line-height:1; color:#fbbf24; }
  #notifyBell:hover{ filter:brightness(1.1); }

  /* Panel th√¥ng b√°o */
  #notifyPanel{ position:fixed; top:40px; right:16px; width:280px; display:none; overflow:hidden; z-index:2001;
    background:#0f1830; color:#e6edff; border:1px solid #2a3d6a; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.45); }
  #notifyPanel .np-head{ padding:10px 12px; font-weight:700; border-bottom:1px solid #22345c; background:#11214a; }
  #notifyPanel .np-body{ max-height:50vh; overflow:auto; }
  #notifyPanel .np-item{ padding:10px 12px; border-bottom:1px dashed #20345e; font-size:14px; }
  #notifyPanel .np-item time{ display:block; font-size:12px; color:#9aa7c7; margin-top:4px; }
  #notifyPanel .np-empty{ padding:14px; color:#9aa7c7; font-size:14px; text-align:center; }

  /* C·ªôt k√≠ch th∆∞·ªõc */
  th.col-don-hang, td.col-don-hang { width: 180px; max-width: 260px; }
  th.col-nv-xn, td.col-nv-xn,
  th.col-nv-gl, td.col-nv-gl { width: 120px; max-width:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  th.col-ngay-dh, td.col-ngay-dh { width: 140px; max-width:140px; white-space:nowrap; }

  .inline-label{ font-size:14px; opacity:.85 }
  #sbState{ gap:10px; }

  .update-row{ display:flex; gap:10px; align-items:center; margin:10px 0 0; flex-wrap:wrap; }
  #capDate{ min-width:180px; }
  #btnCapNhatDon{ white-space:nowrap; }

  /* (tu·ª≥ ch·ªçn) tinh ch·ªânh pager */
  #pager .btn-action{ padding:8px 12px; }
  #pgSize{ padding:6px 10px; background:#0b1220; color:#e6edff; border:1px solid #2a3d6a; border-radius:8px; }
</style>
</head>
<body>

<!-- Chu√¥ng th√¥ng b√°o -->
<button id="notifyBell" title="Th√¥ng b√°o" aria-label="Th√¥ng b√°o">üîî</button>


<div id="userBar" class="ub">
  <button id="userToggle" class="ub-toggle" type="button">
    <span class="ub-ico">üë§</span>
    <span id="userName"></span>
  </button>

  <div id="userMenu" class="ub-menu" hidden>
    <button id="actLogout" class="ub-item" type="button">ƒêƒÉng xu·∫•t</button>
  </div>
</div>



<!-- Panel th√¥ng b√°o -->
<div id="notifyPanel" role="dialog" aria-hidden="true">
  <div class="np-head">Th√¥ng b√°o</div>
  <div class="np-body" id="notifyList">
    <div class="np-empty">Ch∆∞a c√≥ th√¥ng b√°o.</div>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <h1>Ki·ªÉm tra ƒë∆°n h√†ng</h1>

    <div class="scan-row">
      <input id="scan" placeholder="Qu√©t / nh·∫≠p m√£ h√≥a ƒë∆°n" />
      <button id="btnCheck"  class="btn-action">Check ƒë∆°n h√†ng</button>
      <button id="btnPrepTop" class="btn-action">Chu·∫©n b·ªã ƒë∆°n</button>
    </div>
    <div id="scanMsg" class="state muted" style="margin-top:6px;"></div>

    <div class="top">
      <input id="q" class="grow" placeholder="Nh·∫≠p ma_hd / t√™n KH‚Ä¶" />
      <input id="from" class="grow" placeholder="T·ª´ ng√†y (dd-mm-yyyy ho·∫∑c yyyy-mm-dd)" />
      <input id="to"   class="grow" placeholder="ƒê·∫øn ng√†y (dd-mm-yyyy ho·∫∑c yyyy-mm-dd)" />
      <button id="btnReload">‚ü≥ T·∫£i l·∫°i</button>
      <button id="btnExpand" title="M·ªü r·ªông/thu g·ªçn v√πng l√†m vi·ªác">‚Üî M·ªü r·ªông</button>
    </div>

    <div class="muted">B·∫£ng: <b id="tblName">don_hang</b> ‚Äî hi·ªÉn th·ªã <b>dd-mm-yyyy</b></div>

    <div class="state muted" id="sbState" style="display:flex;align-items:center;flex-wrap:wrap">
      Supabase: <b id="sbMsg" class="muted" style="margin:0 8px;">ƒëang t·∫£i‚Ä¶</b>

      <button id="btnFilterChecked" class="btn-action" title="Ch·ªâ hi·ªÉn th·ªã c√°c ƒë∆°n ƒë√£ ch·ªçn">L·ªçc ƒë√£ ch·ªçn</button>
      <span id="selCount" class="badge" style="margin-left:8px">ƒê√£ ch·ªçn: <b id="chkCount">0</b></span>
      <button id="btnViewRoute" class="btn-action" title="Xem b·∫£n ƒë·ªì tuy·∫øn theo c√°c ƒë∆°n ƒë√£ ch·ªçn">Xem b·∫£n ƒë·ªì tuy·∫øn</button>

      <label class="inline-label" for="filterLoaiDon">Lo·∫°i ƒë∆°n h√†ng:</label>
      <select id="filterLoaiDon" title="L·ªçc theo c·ªôt cod c·ªßa don_hang">
        <option value="">T·∫•t c·∫£</option>
        <option value="true">ƒê∆°n h√†ng COD</option>
        <option value="false">ƒê∆°n kh√¥ng COD</option>
      </select>

      <label class="inline-label" for="filterTrangThai">Tr·∫°ng th√°i:</label>
      <select id="filterTrangThai" title="L·ªçc theo c·ªôt tr·∫°ng_th√°i">
        <option value="">T·∫•t c·∫£</option>
      </select>
      

      <span class="right-end">
        <label for="capDate" class="inline-label">Ng√†y c·∫≠p nh·∫≠t:</label>
        <input id="capDate" type="date" />
        <button id="btnCapNhatDon" class="btn-action">‚ö° C·∫≠p nh·∫≠t ƒë∆°n h√†ng</button>
      </span>
    </div>

    <div class="grid">
      <table>
        <thead>
          <tr>
            <th style="width:48px;text-align:center">
              <input type="checkbox" id="chkAll" title="Ch·ªçn t·∫•t c·∫£" />
            </th>
            <th style="width:170px">m√£ h√≥a ƒë∆°n</th>
            <th class="col-don-hang">ƒë∆°n h√†ng</th>
            <th style="width:150px; text-align:center;">ng√†y</th>
            <th style="width:220px">t√™n kh</th>
            <th style="width:150px" class="right">t·ªïng ti·ªÅn</th>
            <th class="col-trang-thai" style="width:200px;">tr·∫°ng th√°i</th>
            <th class="col-ngay-xn">ng√†y check ƒë∆°n</th>
            <th class="col-nv-xn">nv check ƒë∆°n</th>
            <th class="col-nv-gl">nh√¢n vi√™n giao</th>
            <th style="width:120px"></th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="11" class="empty">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>
        </tbody>
      </table>

      <!-- ‚úÖ PAGER: ph√¢n trang offset-based -->
      <div id="pager" style="display:flex;align-items:center;gap:10px;justify-content:space-between;margin-top:10px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:10px">
          <button id="pgPrev" class="btn-action">¬´ Tr∆∞·ªõc</button>
          <button id="pgNext" class="btn-action">Sau ¬ª</button>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <label for="pgSize" class="inline-label">D√≤ng/trang:</label>
          <select id="pgSize">
            <option>50</option>
            <option selected>100</option>
            <option>200</option>
          </select>
          <span id="pgInfo" class="muted">Trang 1/1 ‚Äî 0 b·∫£n ghi</span>
        </div>
      </div>

      <datalist id="empList"></datalist>
    </div>
  </div>
</div>

<!-- Overlay chi ti·∫øt -->
<div id="detailOverlay" aria-hidden="true">
  <div id="detailPanel" role="dialog" aria-modal="true" aria-label="Chi ti·∫øt ƒë∆°n giao h√†ng">
    <div id="detailHead">
      <div class="title">Chi ti·∫øt ƒë∆°n giao h√†ng</div>
      <div>
        <button id="detailOpenNew" type="button">‚Üó M·ªü trang ri√™ng</button>
        <button id="detailClose"   type="button">ƒê√≥ng ‚úï</button>
      </div>
    </div>
    <iframe id="detailFrame" src="" title="Chi ti·∫øt ƒë∆°n"></iframe>
  </div>
</div>

<!-- Kh·ªüi t·∫°o panel th√¥ng b√°o -->
<script>
  (function notifInit(){
    const bell = document.getElementById('notifyBell');
    const panel = document.getElementById('notifyPanel');
    const list  = document.getElementById('notifyList');
    if(!bell || !panel) return;

    function toggle(){ panel.style.display = (panel.style.display==='block' ? 'none' : 'block'); }
    bell.addEventListener('click', toggle);
    document.addEventListener('click', (e)=>{
      if(panel.style.display!=='block') return;
      if(panel.contains(e.target) || bell.contains(e.target)) return;
      panel.style.display='none';
    });

    if(list){ list.innerHTML = `<div class="np-empty">Ch∆∞a c√≥ th√¥ng b√°o.</div>`; }
  })();
</script>

<!-- QUAN TR·ªåNG: ƒë·∫∑t API_BASE ƒë·ªÉ check_don.js g·ªçi ƒë√∫ng /api/getConfig khi ch·∫°y local -->
<script>
  (function setApiBase(){
    // Cho ph√©p override b·∫±ng query ?apiBase=https://your-domain
    const q = new URLSearchParams(location.search);
    const override = q.get('apiBase');

    // M·∫∑c ƒë·ªãnh: d√πng c√πng origin
    let base = override || (location.origin.startsWith('http') ? location.origin : '');

    // Heuristic cho dev: n·∫øu ƒëang m·ªü site tr√™n port kh√°c API (v√≠ d·ª• site 5000, API 3000)
    if (!override && /localhost|127\.0\.0\.1/.test(location.hostname)) {
      // N·∫øu origin l√† file:// ho·∫∑c port kh√¥ng ph·∫£i 3000 ‚Üí gi·∫£ ƒë·ªãnh API ·ªü 3000 (Next dev)
      if (!base || (location.port && location.port !== '3000')) {
        base = 'http://localhost:3000';
      }
    }

    // G√°n cho app d√πng
    window.API_BASE = base.replace(/\/+$/,'');
    // getInternalKey ƒë∆∞·ª£c cung c·∫•p b·ªüi internal_key.js
    console.log('[APP] API_BASE =', window.API_BASE, '| has key:', typeof window.getInternalKey==='function');
  })();
</script>

<!-- ·ª®ng d·ª•ng -->
<script src="./js/check_don.js"></script>

<!-- ‚úÖ C·∫¶U N·ªêI PH√ÇN TRANG CHO check_don.js -->
<script>
/* ========= Ph√¢n trang offset-based: C·∫¶U N·ªêI =========
   check_don.js ch·ªâ c·∫ßn:
   - d√πng getPageRange() => .range(from, to)
   - sau khi truy v·∫•n: setTotalCount(count || 0)
   B·ªô l·ªçc (q/from/to/filterLoaiDon/filterTrangThai) ƒë·ªïi ‚Üí t·ª± v·ªÅ trang 1 v√† reload().
*/
(function paginationBridge(){
  const st = window.__PAGER = {
    size: 100,
    page: 1,
    total: 0,
  };

  const elPrev = document.getElementById('pgPrev');
  const elNext = document.getElementById('pgNext');
  const elSize = document.getElementById('pgSize');
  const elInfo = document.getElementById('pgInfo');

  function totalPages(){ return Math.max(1, Math.ceil(st.total / st.size)); }
  function clampPage(n){ return Math.min(Math.max(1, n), totalPages()); }

  function updateUI(){
    if(elInfo) elInfo.textContent = `Trang ${st.page}/${totalPages()} ‚Äî ${st.total} b·∫£n ghi`;
    if(elPrev) elPrev.disabled = (st.page <= 1);
    if(elNext) elNext.disabled = (st.page >= totalPages());
    if(elSize && String(st.size) !== elSize.value) elSize.value = String(st.size);
  }

  function goTo(n){
    st.page = clampPage(n);
    updateUI();
    if (typeof window.reload === 'function') window.reload();
  }

  // Public API cho check_don.js
  window.getPageRange = function(){
    const from = (st.page - 1) * st.size;
    const to   = from + st.size - 1;
    return { from, to, size: st.size };
  };
  window.setTotalCount = function(n){
    st.total = Number(n) || 0;
    if (st.page > totalPages()) st.page = totalPages();
    updateUI();
  };
  window.resetToPage1 = function(){
    st.page = 1;
    updateUI();
  };

  // G·∫Øn s·ª± ki·ªán UI
  elPrev?.addEventListener('click', ()=> goTo(st.page - 1));
  elNext?.addEventListener('click', ()=> goTo(st.page + 1));
  elSize?.addEventListener('change', ()=>{
    const v = parseInt(elSize.value, 10) || 100;
    st.size = v;
    st.page = 1;                 // ƒë·ªïi size th√¨ v·ªÅ trang 1
    updateUI();
    if (typeof window.reload === 'function') window.reload();
  });

  // Khi thay ƒë·ªïi b·ªô l·ªçc/t√¨m ki·∫øm ‚Üí reset trang 1 + reload
  ['q','from','to','filterLoaiDon','filterTrangThai'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const fire = ()=>{ window.resetToPage1(); if (typeof window.reload==='function') window.reload(); };
    if (id==='q'){
      // debounce nh·∫π cho input q
      let t = null;
      el.addEventListener('input', ()=>{
        clearTimeout(t);
        t = setTimeout(fire, 300);
      });
    }else{
      el.addEventListener('change', fire);
    }
  });

  // Kh·ªüi t·∫°o
  updateUI();
})();
</script>

<!-- T·∫°o token ƒë·ªÉ m·ªü -->
<script src="./js/auth_token.js"></script>
<script>
document.getElementById('btnViewRoute')?.addEventListener('click', () => {
  const token = makeAccess(); // t·∫°o token ng·∫´u nhi√™n cho l·∫ßn m·ªü n√†y
  location.href = `map_tuyen.html?token=${token}`;
});
</script>

</body>
</html>
