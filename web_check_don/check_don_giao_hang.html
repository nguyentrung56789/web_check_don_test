<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kiểm tra đơn hàng — Form con</title>

  <!-- CSS gộp từ check_don_giao_hang.css -->
  <style>
table.ct { border-collapse:separate; border-spacing:0; width:100%; min-width:900px }
table.ct th, table.ct td { white-space:nowrap }
table.ct thead th { text-align:left }
table.ct thead th.right, table.ct td.right { text-align:right }
table.ct col.w-ma{width:160px}.w-don{width:110px}.w-sl{width:90px}.w-k{width:120px}.w-tien{width:140px}

.kiem-input{width:72px;text-align:right;background:#0e1632;border:1px solid var(--line);border-radius:8px;padding:6px 8px}

:root{ --bg:#0b1220; --panel:#0f1830; --line:#192542; --txt:#e6edff; --muted:#93a2c7; --ok:#2dd4bf; --err:#ff6b6b; --chip:#13244a; --brand:#69b4ff }
html,body{background:var(--bg);color:var(--txt);margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1100px;margin:auto;padding:18px}
h1{margin:0 0 12px;font-size:24px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grow{flex:1;min-width:180px}
input,button{background:#111b3a;color:var(--txt);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
.box{margin-top:12px;border:1px dashed var(--line);border-radius:12px;padding:12px}

.kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin:6px 0}
.kv .k{color:#9fb6ff}.kv .v{font-weight:400}
.kv-inline{display:grid;grid-template-columns:160px 1fr 120px minmax(140px,280px);gap:8px;align-items:center}
.kv-inline .k.right{text-align:right}
.lower{text-transform:lowercase}

.stat b.ok{color:var(--ok)} .stat b.err{color:var(--err)}
.hint{font-size:12px;color:#93a2c7}
#scanMH.scan-focus{border-color:#2dd4bf;box-shadow:0 0 0 2px rgba(45,212,191,.55),0 0 14px rgba(45,212,191,.45)}

.emp-group{display:flex;gap:8px;align-items:center;flex:1;min-width:320px}
.btn-green{background:#153a21;border:1px solid #1e7f3b;color:#9FE870;font-weight:600;cursor:pointer}
.btn-green:hover{filter:brightness(1.08)} .btn-green:active{transform:translateY(1px)}
.btn-green:disabled{opacity:.55;cursor:not-allowed;filter:saturate(.5)}

.grid{margin-top:12px;border:1px solid var(--line);border-radius:12px;overflow:auto;background:var(--panel)}
table{border-collapse:separate;border-spacing:0;width:100%;min-width:900px}
thead th{position:sticky;top:0;background:var(--panel);z-index:1;padding:10px;border-bottom:1px solid var(--line);text-align:left;color:#89c2ff}
tbody td{padding:10px;border-bottom:1px dashed var(--line)}
td.right{text-align:right}
tr:hover td{background:#0e1731}

tr.done td{background:rgba(45,212,191,.06)}
tr.over td{background:rgba(255,107,107,.08)}
tr.done .kiem-input{border-color:rgba(45,212,191,.45)}
tr.over .kiem-input{border-color:var(--err);color:#ffb4b4}

tfoot td{padding:12px 10px;border-top:1px solid var(--line);font-weight:700}
.total-blue{color:var(--ok);font-size:16px}
@media (max-width:700px){ .kv-inline{grid-template-columns:160px 1fr} .kv-inline .k.right{text-align:left} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Kiểm tra đơn hàng</h1>

    <div class="box">
      <div class="kv"><div class="k">mã hóa đơn:</div><div class="v" id="v_mahd">—</div></div>
      <div class="kv-inline">
        <div class="k">tên khách hàng:</div>
        <div class="v lower" id="v_tenkh">—</div>
        <div class="k right">điện thoại:</div>
        <div class="v lower" id="v_dthoai">—</div>
      </div>
      <div class="kv"><div class="k">địa chỉ:</div><div class="v lower" id="v_dc">—</div></div>
      <div class="kv"><div class="k">tổng tiền hd:</div><div class="v" id="v_tong">—</div></div>
      <div id="state" class="stat" style="margin-top:6px">Supabase: <b class="ok">đang tải…</b></div>
    </div>

    <div class="box">
      <div class="row">
        <div class="emp-group">
          <input id="nvConfirm" list="nvList" class="grow" placeholder="— chọn / tìm nhân viên xác nhận —" />
          <button id="btnConfirm" class="btn-green" disabled>Xác nhận</button>
        </div>
        <div class="emp-group">
          <input id="nvShip" list="nvList" class="grow" placeholder="— chọn / tìm nhân viên giao hàng —" />
          <button id="btnShip" class="btn-green" disabled>Giao hàng</button>
        </div>
        <datalist id="nvList"></datalist>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="scanMH" class="grow" placeholder="Quét / nhập mã hàng (ma_h) rồi Enter…" />
        <input id="searchMH" class="grow" placeholder="Tìm theo tên hàng…" />
      </div>
      <div class="hint" style="margin-top:6px">
        • Có thể <b>gõ số</b> vào cột “kiểm hàng”. Vượt số lượng → đỏ, bằng số lượng → xanh ✓.
      </div>
    </div>

    <div class="grid">
      <table class="ct">
        <colgroup>
          <col class="w-ma"><col><col class="w-don"><col class="w-sl"><col class="w-k"><col class="w-tien">
        </colgroup>
        <thead>
          <tr>
            <th>mã hàng</th>
            <th>tên hàng</th>
            <th class="right">đơn giá</th>
            <th class="right">số lượng</th>
            <th class="right">kiểm hàng</th>
            <th class="right">thành tiền</th>
          </tr>
        </thead>
        <tbody id="ctBody">…</tbody>
        <tfoot>
          <tr>
            <td></td><td class="right total-blue">tổng</td>
            <td class="right total-blue"></td>
            <td class="right total-blue" id="sumSL">—</td>
            <td class="right total-blue" id="sumKiem">—</td>
            <td class="right total-blue" id="sumTien">—</td>
          </tr>
        </tfoot>
      </table>
    </div>

  </div>
</div>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- JS gộp từ check_don_giao_hang.js -->
<script>
/* ===== CONFIG ===== */
const CFG_CACHE_KEY='cod_cfg_cache_v2';
const EMP_TABLE='kv_nhan_vien';
const EMP_NAME_COL='ten_nv';
let   EMP_ID_COL=null; // auto-detect: id -> id_nv -> ma_nv

/* ===== Helpers ===== */
const esc=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
function getParam(n){return new URLSearchParams(location.search).get(n)||''}
function money(v){try{return Number(v).toLocaleString('vi-VN')}catch{return v??''}}
function setSBState(ok,msg){document.getElementById('state').innerHTML=`Supabase: <b class="${ok?'ok':'err'}">${esc(msg)}</b>`}

/* ===== add small CSS for locked input (auto inject) ===== */
(function injectLockedCss(){
  const css = `
    #nvConfirm.locked{
      background:#0f223f !important;
      color:#b7c8ff !important;
      border-color:#264a85 !important;
      cursor:not-allowed;
    }
  `;
  const st=document.createElement('style'); st.textContent=css; document.head.appendChild(st);
})();

/* ===== Supabase client (singleton) ===== */
let _supa=null;
async function getClient(){ if(_supa) return _supa; const cfg=await loadConfig(); _supa=window.supabase.createClient(cfg.url,cfg.key); return _supa; }

/* ===== Tải INTERNAL KEY (giống form cha) & gọi /api/getConfig ===== */
async function ensureInternalKeyLoaded() {
  if (typeof window.getInternalKey === 'function') return window.getInternalKey() || '';
  await new Promise((resolve)=> {
    const s=document.createElement('script');
    s.src='./internal_key.js';
    s.onload=resolve; s.onerror=resolve;
    document.head.appendChild(s);
  });
  return (typeof window.getInternalKey === 'function') ? (window.getInternalKey() || '') : '';
}

/* >>> loadConfig độc lập: /api/getConfig -> cache -> cod_config.js -> cod_config.json <<< */
async function loadConfig(){
  // 1) ưu tiên /api/getConfig (GIỐNG FORM CHA)
  try{
    const INTERNAL_KEY = await ensureInternalKeyLoaded();
    const r = await fetch('/api/getConfig', {
      headers: { 'x-internal-key': INTERNAL_KEY || '' },
      cache: 'no-store'
    });
    if (r.ok) {
      const { url, anon } = await r.json();
      if (url && anon) {
        const cfg = { url, key: anon };
        localStorage.setItem(CFG_CACHE_KEY, JSON.stringify(cfg));
        return cfg;
      }
    }
  } catch(_) {}

  // 2) cache localStorage
  try{
    const raw = localStorage.getItem(CFG_CACHE_KEY);
    if (raw) return JSON.parse(raw);
  }catch(_){}

  // 3) fallback: cod_config.js (nếu có)
  const byJs = await new Promise(res=>{
    let done=false;const s=document.createElement('script');s.src='cod_config.js';
    s.onload=()=>{done=true;res(window.COD_CONFIG||null)};s.onerror=()=>res(null);
    setTimeout(()=>{if(!done)res(window.COD_CONFIG||null)},300);document.head.appendChild(s);
  });
  if (byJs && byJs.url && (byJs.key || byJs.anon)) {
    const cfg = { url: byJs.url, key: byJs.key || byJs.anon };
    localStorage.setItem(CFG_CACHE_KEY, JSON.stringify(cfg));
    return cfg;
  }

  // 4) fallback: cod_config.json (nếu có)
  try{
    const r=await fetch('cod_config.json',{cache:'no-store'});
    if(r.ok){
      const j=await r.json();
      if (j.url && (j.key || j.anon)) {
        const cfg = { url: j.url, key: j.key || j.anon };
        localStorage.setItem(CFG_CACHE_KEY, JSON.stringify(cfg));
        return cfg;
      }
    }
  }catch(_){}

  throw new Error('Không lấy được cấu hình Supabase từ /api/getConfig và không tìm thấy fallback.');
}

/* ===== Lấy danh sách NV (kèm ID nếu có) ===== */
async function fillEmployees(){
  const supa=await getClient();
  const dl=document.getElementById('nvList');
  const candidates=['id','id_nv','ma_nv'];
  let data=null, idCol=null;

  for(const col of candidates){
    try{
      const r=await supa.from(EMP_TABLE).select(`${col}, ${EMP_NAME_COL}`).order(EMP_NAME_COL,{ascending:true}).limit(2000);
      if(!r.error && Array.isArray(r.data)){ data=r.data; idCol=col; break; }
    }catch(_){}
  }
  if(!data){
    const r=await supa.from(EMP_TABLE).select(EMP_NAME_COL).order(EMP_NAME_COL,{ascending:true}).limit(2000);
    data=r.data||[]; idCol=null;
  }

  EMP_ID_COL=idCol;
  dl.innerHTML=(data||[]).map(r=>{
    const name=(r?.[EMP_NAME_COL]??'').toString().trim();
    const id=idCol ? (r?.[idCol]??'') : '';
    const attrId = id ? ` data-id="${esc(id)}"` : '';
    return `<option value="${esc(name)}"${attrId}></option>`;
  }).join('');
}
function getEmpIdByName(name){
  const dl=document.getElementById('nvList');
  const opt=[...dl.options].find(o=>o.value===name);
  return opt?.dataset?.id || '';
}

/* ===== [Giữ nguyên] Prefill NV xác nhận từ URL (nếu có) ===== */
const NV_XN_FROM_PARENT = (getParam('nv_xn') || '').trim();
function prefillNhanVienXacNhanFromParent(){
  if(!NV_XN_FROM_PARENT) return;
  const ip = document.getElementById('nvConfirm');
  if(!ip) return;
  ip.value = NV_XN_FROM_PARENT;
  ip.dispatchEvent(new Event('input', { bubbles: true }));
  ip.readOnly = true;
  ip.removeAttribute('list');
  ip.setAttribute('aria-readonly','true');
  ip.classList.add('locked');
  ip.title = 'Tên NV được gán từ tham số URL';
}

/* ===== UI phụ ===== */
function setupScanFocus(){ const scan=document.getElementById('scanMH'); const add=()=>scan.classList.add('scan-focus'); const rm=()=>scan.classList.remove('scan-focus'); scan.addEventListener('focus',add); scan.addEventListener('blur',rm); setTimeout(()=>{scan.focus();add();},0); }

function updateButtonsState(){
  const rows=[...document.querySelectorAll('#ctBody tr[data-ma]')];
  const allMatch=rows.length>0 && rows.every(tr=>{
    const qty=Number(tr.dataset.qty)||0;
    const kiem=Number(tr.querySelector('.kiem-input').value)||0;
    return kiem===qty;
  });
  document.getElementById('btnConfirm').disabled=!allMatch;
  document.getElementById('btnShip').disabled=!allMatch;
}
function decorateRow(tr, qty, kiem){
  tr.classList.remove('done','over');
  const tick=tr.querySelector('.kiem-tick');
  if(kiem>qty){tr.classList.add('over'); tick.textContent='';}
  else if(kiem===qty){tr.classList.add('done'); tick.textContent='✓';}
  else {tick.textContent='';}
}

/* ===== Load header ===== */
async function loadOrderInfo(){
  const supa=await getClient();
  const ma_hd=getParam('ma_hd').trim();document.getElementById('v_mahd').textContent=ma_hd||'—';
  if(!ma_hd){setSBState(false,'thiếu ma_hd trên URL');return}
  try{
    const {data,error}=await supa.from('don_hang')
      .select('ma_hd,ten_kh,dia_chi,tong_tien,dien_thoai')
      .eq('ma_hd',ma_hd).maybeSingle();
    if(error)throw error;if(!data){setSBState(false,'không tìm thấy đơn');return}
    document.getElementById('v_tenkh').textContent=data.ten_kh||'—';
    document.getElementById('v_dthoai').textContent=data.dien_thoai||'—';
    document.getElementById('v_dc').textContent=data.dia_chi||'—';
    document.getElementById('v_tong').textContent=data.tong_tien!=null?money(data.tong_tien):'—';
    setSBState(true,'sẵn sàng');
  }catch(e){setSBState(false,e.message||e)}
}

/* ===== Load chi tiết ===== */
async function loadOrderLines(){
  const supa=await getClient();
  const ma_hd=getParam('ma_hd').trim();
  const tb=document.getElementById('ctBody');
  if(!ma_hd){tb.innerHTML='<tr><td colspan="6" class="muted">thiếu mã hóa đơn.</td></tr>';return;}

  try{
    const {data,error}=await supa
      .from('don_hang_chitiet')
      .select('ma_h,ten_h,don_gia,so_luong,so_luong_kiem,thanh_tien')
      .eq('ma_hd',ma_hd).order('ma_h',{ascending:true});
    if(error) throw error;
    if(!data||!data.length){tb.innerHTML='<tr><td colspan="6" class="muted">không có chi tiết.</td></tr>';return;}

    let sumQty=0,sumAmt=0,sumKiem=0;
    tb.innerHTML=data.map(r=>{
      const qty=Number(r.so_luong)||0;
      const kiem=Number(r.so_luong_kiem)||0;
      const amt=Number(r.thanh_tien)||0;
      sumQty+=qty; sumAmt+=amt; sumKiem+=kiem;
      return `
        <tr data-ma="${esc(r.ma_h||'')}" data-qty="${qty}">
          <td>${esc(r.ma_h||'')}</td>
          <td>${esc(r.ten_h||'')}</td>
          <td class="right">${r.don_gia!=null?money(r.don_gia):''}</td>
          <td class="right">${qty}</td>
          <td class="right">
            <input class="kiem-input" type="number" min="0" value="${kiem}" />
            <span class="kiem-tick" style="margin-left:8px;color:#2dd4bf;font-weight:700;"></span>
          </td>
          <td class="right">${amt?money(amt):''}</td>
        </tr>`;
    }).join('');

    document.getElementById('sumSL').textContent=sumQty;
    document.getElementById('sumKiem').textContent=sumKiem;
    document.getElementById('sumTien').textContent=money(sumAmt);

    const rows=[...tb.querySelectorAll('tr[data-ma]')];
    function recalc(){
      let sK=0;
      rows.forEach(tr=>{
        const qty=Number(tr.dataset.qty)||0;
        const inp=tr.querySelector('.kiem-input');
        const v=Math.max(0,Number(inp.value||0));
        inp.value=v; sK+=v; decorateRow(tr,qty,v);
      });
      document.getElementById('sumKiem').textContent=sK;
      updateButtonsState();
    }
    rows.forEach(tr=>{
      const qty=Number(tr.dataset.qty)||0;
      const inp=tr.querySelector('.kiem-input');
      decorateRow(tr,qty,Number(inp.value||0));
      inp.addEventListener('input',recalc);
    });
    updateButtonsState();

  }catch(e){
    tb.innerHTML=`<tr><td colspan="6" class="muted">lỗi: ${esc(e.message||e)}</td></tr>`;
  }
}

/* ===== Gom kiểm tra dùng chung ===== */
function collectStates(){
  const rows=[...document.querySelectorAll('#ctBody tr[data-ma]')];
  return rows.map(tr=>({
    ma:tr.dataset.ma,
    qty:Number(tr.dataset.qty)||0,
    kiem:Number(tr.querySelector('.kiem-input').value)||0,
    el:tr
  }));
}
function ensureAllMatched(states){
  const bad=states.filter(s=>s.kiem!==s.qty);
  const over=states.filter(s=>s.kiem>s.qty);
  return {badCount:bad.length,overCount:over.length,firstBadEl:bad[0]?.el};
}

/* ===== Ghi DB ===== */
/* ===== Ghi DB ===== */
async function writeUpdates(states,nvConfirmName,nvShipName){
  const supa=await getClient();
  const ma_hd=getParam('ma_hd').trim();

  const lineResults=await Promise.all(states.map(s=>
    supa.from('don_hang_chitiet').update({so_luong_kiem:s.kiem})
      .eq('ma_hd',ma_hd).eq('ma_h',s.ma).select('ma_hd,ma_h')
  ));
  const affected=lineResults.reduce((n,r)=>n+((r.data&&r.data.length)||0),0);
  if(affected!==states.length) throw new Error(`chỉ cập nhật được ${affected}/${states.length} dòng (kiểm tra RLS/ma_hd/ma_h).`);



const upd = {
  nv_check_don: nvConfirmName,
  ngay_check_don: new Date().toISOString(),  // thêm dòng này
  trang_thai: 'Đã kiểm đơn'
};

if (nvShipName) upd.nv_giao_hang = nvShipName;


  const {data,error}=await supa.from('don_hang').update(upd).eq('ma_hd',ma_hd).select('ma_hd');
  if(error) throw error; if(!data||!data.length) throw new Error('không tìm thấy đơn để cập nhật.');
}


/* ===== ĐÓNG FORM: fallback ===== */
function closeChildForm(){
  try { window.onbeforeunload = null; } catch(_){}
  try{ window.close(); }catch(_){}
  try{ window.open('','_self'); window.close(); }catch(_){}
  try{ location.replace('about:blank'); }catch(_){}
}

/* ===== Gọi webhook NGẦM (không mở trang) ===== */
function callWebhookSilent(params){
  const base='https://dhsybbqoe.datadex.vn/webhook/xac-nhan-don-hang';
  const url = `${base}?` + new URLSearchParams(params).toString();
  try{
    const img=new Image(1,1);
    img.style.position='absolute'; img.style.opacity='0'; img.style.pointerEvents='none';
    img.src=url+'&_='+Date.now();
    img.onload=img.onerror=()=>{try{img.remove();}catch(_){}}; document.body.appendChild(img);
  }catch(_){}
  try{ fetch(url,{method:'GET',mode:'no-cors',keepalive:true}).catch(()=>{}); }catch(_){}
}

/* ===== Bind UI ===== */
let IS_SUBMITTING = false;

function bindItemsUI(){
  const scan=document.getElementById('scanMH');
  const search=document.getElementById('searchMH');

  scan.addEventListener('keydown',e=>{
    if(e.key==='Enter'){
      e.preventDefault();
      const code=(scan.value||'').trim(); if(!code) return;
      const tr=document.querySelector(`#ctBody tr[data-ma="${CSS.escape(code)}"]`);
      if(!tr){ setSBState(false,`không tìm thấy mã hàng: ${esc(code)}`); scan.value=''; scan.focus(); return; }
      const inp=tr.querySelector('.kiem-input');
      inp.value=(Number(inp.value||0)+1);
      inp.dispatchEvent(new Event('input',{bubbles:true}));
      updateButtonsState(); scan.value=''; scan.focus();
    }
  });
  search.addEventListener('input',()=>{ const kw=search.value.trim(); if(kw.length>=2){ console.log('Tìm tên hàng:',kw); } });

  // Xác nhận (ghi DB + webhook + gửi sự kiện cho form cha nếu có + đóng form)
  document.getElementById('btnConfirm').addEventListener('click', async ()=>{
    if (IS_SUBMITTING) return;
    IS_SUBMITTING = true;

    const nvConfirm=(document.getElementById('nvConfirm').value||'').trim();
    const nvShip   =(document.getElementById('nvShip').value||'').trim();
    if(!nvConfirm){ setSBState(false,'vui lòng chọn nhân viên xác nhận'); document.getElementById('nvConfirm').focus(); IS_SUBMITTING=false; return; }

    const states=collectStates(); if(!states.length){ setSBState(false,'không có dòng chi tiết để xác nhận'); IS_SUBMITTING=false; return; }
    const {badCount,overCount,firstBadEl}=ensureAllMatched(states);
    if(badCount){
      const msg=overCount?`còn ${badCount} dòng chưa khớp (có ${overCount} dòng vượt quá). kiểm tra lại nhé.`:`còn ${badCount} dòng chưa khớp. kiểm tra lại nhé.`;
      setSBState(false,msg); if(firstBadEl) firstBadEl.scrollIntoView({behavior:'smooth',block:'center'}); IS_SUBMITTING=false; return;
    }

    try{
      await writeUpdates(states,nvConfirm,nvShip||null);

      // webhook phụ (im lặng)
      const params={
        ma_hd:getParam('ma_hd').trim(),
        id_xac_nhan:getEmpIdByName(nvConfirm),
        ten_xac_nhan:nvConfirm,
        id_giao_hang:getEmpIdByName(nvShip),
        ten_giao_hang:nvShip
      };
      callWebhookSilent(params);

      setSBState(true,'xác nhận thành công ✓ (đã gửi webhook)');

      // nếu có cửa sổ cha (mở từ form cha) thì gửi event — còn không thì bỏ qua (độc lập)
      try {
        const target = window.opener || window.parent;
        if (target && target !== window) {
          const action = (nvShip && nvShip.length) ? 'ship' : 'confirm';
          target.postMessage({
            type: 'don-updated',
            action,
            ma_hd: getParam('ma_hd').trim(),
            nv: action === 'ship' ? nvShip : nvConfirm,
            status: action === 'ship' ? 'Đang giao hàng' : undefined
          }, '*');
          target.postMessage({ type: 'close-overlay' }, '*');
        }
      } catch (_) {}

      // fallback tự đóng nếu là popup
      setTimeout(()=>{ try{ closeChildForm(); }catch(_){ } }, 80);

    }catch(err){
      setSBState(false,'lỗi khi cập nhật: '+(err.message||err));
    } finally {
      IS_SUBMITTING = false;
    }
  });

  // Giao hàng: yêu cầu đủ NV GH + NV XN -> dùng lại Confirm
  document.getElementById('btnShip').addEventListener('click', ()=>{
    const nvShip=(document.getElementById('nvShip').value||'').trim();
    if(!nvShip){
      setSBState(false,'vui lòng chọn nhân viên giao hàng');
      document.getElementById('nvShip').focus();
      return;
    }
    const nvConfirm=(document.getElementById('nvConfirm').value||'').trim();
    if(!nvConfirm){
      setSBState(false,'vui lòng chọn nhân viên xác nhận');
      document.getElementById('nvConfirm').focus();
      return;
    }
    document.getElementById('btnConfirm').click();
  });
}

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadOrderInfo();
  await fillEmployees();
  prefillNhanVienXacNhanFromParent(); // vẫn hỗ trợ tham số URL nếu bạn muốn gán trước
  bindItemsUI();
  setupScanFocus();
  await loadOrderLines();
});
</script>
</body>
</html>
