<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>xem_don_cod</title>

<!-- key nội bộ & supabase -->
<script src="./js/internal_key.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{ --bg:#0b1220; --panel:#0f1830; --line:#192542; --txt:#e6edff; --muted:#93a2c7; }
  html,body{background:var(--bg);color:var(--txt);margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1600px;margin:auto;padding:16px}
  .muted{color:var(--muted)}
  .grid{border:1px solid var(--line);border-radius:14px;overflow:auto;background:var(--panel)}
  table{border-collapse:collapse;table-layout:fixed;width:100%}
  thead, tbody tr{display:table;width:100%;table-layout:fixed}
  thead th{position:sticky;top:0;z-index:5;background:#0b1220;border-bottom:1px solid rgba(255,255,255,.08);
           padding:12px 10px;text-align:left;font-weight:700;text-transform:lowercase;color:#89c2ff;letter-spacing:.1px}
  tbody{display:block;max-height:calc(100vh - 140px);overflow-y:auto}
  tbody td{padding:10px;border-bottom:1px dashed var(--line);vertical-align:top;color:rgba(255,255,255,.9)}
  tr:hover td{background:#0e1731}
  .w100{min-width:100px}
  .nowrap{white-space:nowrap}
  .hhmm { color: #facc15; font-weight: 600; }
  /* nhãn trạng thái (giữ màu chữ đơn giản) */
  .st{font-weight:600}
  .st-wait{color:#f59e0b}.st-cancel{color:#ef4444}.st-ok{color:#22c55e}.st-ship{color:#60a5fa}.st-other{color:#cbd5e1}
  /* hãng VC */
  .vc-shopee{color:#22c55e}.vc-ghn{color:#38bdf8}.vc-ghtk{color:#60a5fa}.vc-best{color:#a78bfa}
  .vc-viettel{color:#f97316}.vc-ninja{color:#ef4444}.vc-other{color:#93a2c7}
</style>
</head>
<body>
<div class="wrap">
  <div class="muted" id="hint">Đang tải…</div>

  <div class="grid" style="margin-top:8px">
    <table>
      <thead>
        <tr>
          <th class="w100">mã vận đơn</th>
          <th class="w100">ngày</th>
          <th class="w100">ngày đóng hàng</th>
          <th class="w100">tên kh</th>
          <th class="w100">địa chỉ</th>
          <th class="w100">vận chuyển</th>
          <th class="w100">trạng thái</th>
          <th class="w100">kênh bán</th>
          <th class="w100">nv bán</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="9" class="muted" style="text-align:center;padding:18px">Chưa có dữ liệu.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
/* ===== Supabase config (tương tự trang gốc) ===== */
const TABLE = 'don_hang_kiot_cod';
let supa = null;

async function getSbConfig(){
  const key = (typeof window.getInternalKey==='function') ? window.getInternalKey() : '';
  const r = await fetch('/api/getConfig', { headers: { 'x-internal-key': key } });
  if(!r.ok) throw new Error('Không lấy được config');
  const j = await r.json();
  if(!j.url || !j.anon) throw new Error('Thiếu url/anon');
  return j;
}

/* ===== helpers ===== */
function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
const fmt=(d)=>{ if(!d) return ''; const dt=(d instanceof Date)?d:(/^\d{4}-\d{2}-\d{2}$/.test(d)?(()=>{const [y,m,day]=d.split('-').map(Number);return new Date(y,m-1,day)})():new Date(d)); if(isNaN(dt)) return ''; const p=n=>String(n).padStart(2,'0'); return `${p(dt.getDate())}-${p(dt.getMonth()+1)}-${dt.getFullYear()}`; };
function statusClass(r){
  const id = String(r.id_tinh_trang ?? '').trim();
  const t  = String(r.trang_thai ?? '').toLowerCase();
  if(id==='1') return 'st-wait';
  if(id==='2') return 'st-cancel';
  if(id==='4') return 'st-ok';
  if(id==='3'||id==='5') return 'st-ship';
  if(t.includes('chờ xử lý')) return 'st-wait';
  if(t.includes('hủy')) return 'st-cancel';
  if(t.includes('thành công')||t.includes('đã giao')) return 'st-ok';
  if(t.includes('chờ giao')||t.includes('đang giao')) return 'st-ship';
  return 'st-other';
}
function shipClass(r){
  let code = String(r.ma_doi_tac ?? r.partner_code ?? r.ma_vc ?? '').toUpperCase().trim().replace(/[^A-Z0-9]/g,'');
  switch (code){ case 'SPX':return'vc-shopee'; case 'GHN':case'GHNFW':return'vc-ghn'; case'GHTK':return'vc-ghtk';
    case'BEST':return'vc-best'; case'VNP':return'vc-vnpost'; case'JT':case'JTFW':return'vc-jt'; case'NJV':case'NJVFW':return'vc-ninja'; default: break; }
  const txt=String(r.van_chuyen??'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  if(txt.includes('shopee'))return'vc-shopee'; if(txt.includes('ghn'))return'vc-ghn'; if(txt.includes('ghtk'))return'vc-ghtk';
  if(txt.includes('best'))return'vc-best'; if(txt.includes('vnpost'))return'vc-vnpost'; if(txt.includes('j&t'))return'vc-jt'; if(txt.includes('ninja'))return'vc-ninja';
  return'vc-other';
}
function formatCloseDate(s){
  if (s==null) return '';
  s = String(s).trim();
  let m = s.match(/^(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2})/);
  if (m){ const [,Y,M,D,H,Min]=m; return `${D}-${M}-${Y} <span class="hhmm">${H}:${Min}</span>`; }
  m = s.match(/^(\d{2})-(\d{2})-(\d{2,4})(?:[ T](\d{2}):(\d{2}))?/);
  if (m){ const [,D,M,YY,H='00',Min='00']=m; const Y = YY.length===2 ? `20${YY}` : YY; return `${D}-${M}-${Y} <span class="hhmm">${H}:${Min}</span>`; }
  return esc(s);
}

/* ===== load rows by ma_hd ===== */
async function reload(){
  const params = new URLSearchParams(location.search);
  const ma_hd = (params.get('ma_hd') || '').trim();
  const hint = document.getElementById('hint');
  hint.innerHTML = ma_hd ? `Lọc theo <b>ma_hd</b>: <b>${esc(ma_hd)}</b>` : 'Không có tham số ma_hd — hiển thị rỗng.';

  const tb=document.getElementById('tbody');
  if(!ma_hd){ tb.innerHTML='<tr><td colspan="9" class="muted" style="text-align:center;padding:18px">Không có ma_hd.</td></tr>'; return; }

  let q = supa.from(TABLE).select('*').eq('ma_hd', ma_hd).order('ngay', {ascending:false}).limit(500);
  const { data, error } = await q;
  if(error){ tb.innerHTML=`<tr><td colspan="9" class="muted" style="text-align:center;padding:18px">Lỗi: ${esc(error.message||error)}</td></tr>`; return; }

  const rows = data || [];
  if(!rows.length){ tb.innerHTML='<tr><td colspan="9" class="muted" style="text-align:center;padding:18px">Không có dữ liệu.</td></tr>'; return; }

  tb.innerHTML = rows.map(r=>`<tr>
    <td>${esc(r.ma_vd||'')}</td>
    <td>${fmt(r.ngay||'')}</td>
    <td class="nowrap">${formatCloseDate(r.ngay_dong_hang)}</td>
    <td>${esc(r.ten_kh||'')}</td>
    <td>${esc(r.dia_chi||'')}</td>
    <td><span class="${shipClass(r)}">${esc(r.van_chuyen||'')}</span></td>
    <td><span class="st ${statusClass(r)}">${esc(r.trang_thai||'')}</span></td>
    <td>${esc(r.kenh_ban||'')}</td>
    <td>${esc(r.nv_ban||'')}</td>
  </tr>`).join('');
}

async function init(){
  try{
    const { url, anon } = await getSbConfig();
    supa = window.supabase.createClient(url, anon);
    await reload();
  }catch(e){
    document.getElementById('hint').innerHTML = `<span class="muted">Supabase:</span> <b style="color:#ff6b6b">${esc(e.message||e)}</b>`;
  }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
