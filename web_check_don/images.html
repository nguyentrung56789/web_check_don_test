<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Render PNG Hidden</title>

<script src="./js/internal_key.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  html,body{margin:0;padding:0;background:#fff;color:#888;font:14px system-ui}
  #stage{display:none}
</style>
</head>
<body>
<script>
(async()=>{
  try {
    // ====== 1. Kiểm tra khóa nội bộ ======
    const expectedKey = window.getInternalKey?.();
    const headerKey = new URLSearchParams(location.search).get('key');
    if(!headerKey || headerKey !== expectedKey){
      document.body.innerHTML = "<h3>403 Forbidden</h3>";
      return;
    }

    // ====== 2. Lấy thông tin Supabase từ internal_key.js ======
    const SUPABASE_URL = getConfig('url');
    const SERVICE_ROLE = getConfig('role');   // dùng role key nội bộ
    const HTML_BUCKET  = 'img_hd_kiot';
    const HTML_KEY     = 'img_hd.html';
    const PNG_BUCKET   = 'images';
    const PNG_KEY      = 'img_hd.png';

    // ====== 3. Tải file HTML nguồn ======
    const htmlUrl = `${SUPABASE_URL}/storage/v1/object/public/${HTML_BUCKET}/${HTML_KEY}`;
    const resp = await fetch(htmlUrl, { mode:'cors', cache:'no-store' });
    if(!resp.ok) throw new Error('Không tải được HTML');
    const html = await resp.text();

    // ====== 4. Tạo DOM tạm (ẩn) ======
    const stage = document.createElement('div');
    stage.id = 'stage';
    stage.innerHTML = html;
    document.body.appendChild(stage);

    // Đợi ảnh load xong
    await Promise.all([...stage.querySelectorAll('img')].map(i => i.complete ? 0 : new Promise(r => (i.onload=i.onerror=r))));

    // ====== 5. Render sang PNG ======
    const canvas = await html2canvas(stage, { backgroundColor:'#fff', scale:2, useCORS:true });
    const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));

    // ====== 6. Upload lên Supabase (ghi đè) ======
    const uploadUrl = `${SUPABASE_URL}/storage/v1/object/${PNG_BUCKET}/${PNG_KEY}`;
    const up = await fetch(uploadUrl, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${SERVICE_ROLE}`,
        'Content-Type': 'image/png',
        'x-upsert': 'true'
      },
      body: blob
    });
    if(!up.ok){
      const t = await up.text().catch(()=> '');
      throw new Error('Upload lỗi: '+t);
    }

    console.log('✅ Uploaded:', `${SUPABASE_URL}/storage/v1/object/public/${PNG_BUCKET}/${PNG_KEY}`);
    document.body.innerHTML = '<p style="color:#4caf50">✔ Hoàn tất upload PNG</p>';

  } catch(e) {
    console.error(e);
    document.body.innerHTML = `<p style="color:red">Lỗi: ${e.message || e}</p>`;
  }
})();
</script>
</body>
</html>
