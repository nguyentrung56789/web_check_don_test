<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Render PNG tr·ª±c ti·∫øp (Vercel)</title>
<script src="./js/internal_key.js"></script>
<style>
  html,body{margin:0;padding:0;background:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:900px;margin:40px auto;padding:0 16px}
  .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin:8px 0}
  input[type=text]{flex:1;min-width:300px;padding:8px;border:1px solid #d1d5db;border-radius:6px}
  button{padding:8px 14px;background:#111827;color:#fff;border:none;border-radius:6px;cursor:pointer}
  .muted{color:#6b7280}
  img{max-width:100%;border:1px solid #e5e7eb;border-radius:12px;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>üß© Render HTML ‚Üí PNG (tr·ª±c ti·∫øp t·ª´ Vercel, kh√¥ng upload)</h1>

  <div class="row">
    <label>File HTML ngu·ªìn:</label>
    <input id="src" type="text" />
  </div>
  <div class="row">
    <button id="btn">Render</button>
    <span id="status" class="muted">S·∫µn s√†ng</span>
  </div>

  <div id="result" style="display:none">
    <p><strong>Link PNG:</strong> <a id="link" href="#" target="_blank" rel="noopener">m·ªü ·∫£nh</a></p>
    <img id="preview" alt="Preview PNG"/>
  </div>
</div>

<script>
(() => {
  const SUPABASE_URL = getConfig("url");
  // API render tr·ª±c ti·∫øp tr√™n Vercel (kh√¥ng tr·∫£ JSON):
  const RENDER_API   = `${location.origin}/api/render.png`;

  const srcInput = document.getElementById("src");
  const btn      = document.getElementById("btn");
  const status   = document.getElementById("status");
  const result   = document.getElementById("result");
  const linkEl   = document.getElementById("link");
  const preview  = document.getElementById("preview");

  // G·ª£i √Ω m·∫∑c ƒë·ªãnh: ƒë√∫ng bucket/file c·ªßa b·∫°n
  srcInput.value = `${SUPABASE_URL}/storage/v1/object/public/img_hd_kiot/img_hd.html`;

  btn.addEventListener("click", async () => {
    try{
      const src = srcInput.value.trim();
      if(!src) return alert("Ch∆∞a nh·∫≠p link HTML ngu·ªìn!");
      status.textContent = "ƒêang render...";

      // T·∫°o URL ·∫£nh PNG tr·ª±c ti·∫øp t·ª´ API render
      const url = new URL(RENDER_API);
      url.searchParams.set("src", src);
      url.searchParams.set("w", "794");
      url.searchParams.set("s", "2");
      url.searchParams.set("ts", Date.now()); // tr√°nh cache

      // Kh√¥ng c·∫ßn fetch JSON ‚Äî ƒë·∫∑t th·∫≥ng src cho <img> v√† href cho <a>
      const pngUrl = url.toString();

      // (Tu·ª≥ ch·ªçn) ping HEAD ƒë·ªÉ b√°o l·ªói s·ªõm n·∫øu endpoint h·ªèng
      const head = await fetch(pngUrl, { method: "HEAD" });
      if(!head.ok) throw new Error(`Render l·ªói: ${head.status}`);

      linkEl.href = pngUrl;
      linkEl.textContent = pngUrl;
      preview.src = pngUrl;
      result.style.display = "";
      status.textContent = "‚úÖ Xong!";
    }catch(e){
      console.error(e);
      status.textContent = "‚ùå " + (e.message || e);
      alert(e.message || e);
    }
  });
})();
</script>
</body>
</html>
